<?xml version="1.0" encoding="UTF-8"?>
<project name="Build integration plugin" default="build-eclipse-integration-plugin">

	<!-- This property is not working currently. -->
	<property name="com.vaadin.eclipse.integration.version" value="1.2.0" />

	<property name="com.vaadin.wysiwyg.eclipse.version" value="0.1.0" />
	<property name="archivePrefix" value="nightly" />
	<property name="update-site-dir" value="update-site" />
	<property name="checkout-dir" value="checkout" />

	<tstamp>
		<format timezone="EEST" property="timestamp" pattern="yyyyMMddHHmm" />
	</tstamp>


	<fail unless="com.vaadin.eclipse.integration.version" message="com.vaadin.eclipse.integration.version must define the plugin version" />
	<property name="com.vaadin.eclipse.integration.fullversion" value="${com.vaadin.eclipse.integration.version}.${timestamp}" />

	<property name="target.dir" location="output" />
	<property name="update-site.dir" location="${target.dir}/${archivePrefix}" />

	<property name="launcher" value="org.eclipse.equinox.launcher_1.0.200.v20090520.jar" />

	<condition property="eclipse.home.ok">
		<available file="${eclipse.home}/eclipse.ini" />
	</condition>
	<fail unless="eclipse.home.ok" message="eclipse.home must be a valid Eclipse installation" />

	<target name="build-eclipse-integration-plugin">
		<delete dir="${update-site.dir}" />

		<java jar="${eclipse.home}/plugins/${launcher}" failonerror="yes" fork="yes" maxmemory="512m">
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-buildfile" />
			<arg value="build-integration-plugin.xml" />
			<arg value="-Dtarget.dir=${target.dir}" />
			<arg value="-Dcom.vaadin.eclipse.integration.version=${com.vaadin.eclipse.integration.version}" />
			<arg value="-Dtimestamp=${timestamp}" />
			<arg value="-DarchivePrefix=${archivePrefix}" />
		</java>

		
	</target>

	<target name="build-eclipse-wysiwyg-plugin">
		<fail unless="gwt.location" message="gwt.location must be defined" />
		<delete dir="${update-site.dir}" />

		<java jar="${eclipse.home}/plugins/${launcher}" failonerror="yes" fork="yes" maxmemory="512m">
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-buildfile" />
			<arg value="build-wysiwyg-plugin.xml" />
			<arg value="-Dtarget.dir=${target.dir}" />
			<arg value="-Dcom.vaadin.wysiwyg.eclipse.version=${com.vaadin.wysiwyg.eclipse.version}" />
			<arg value="-Dtimestamp=${timestamp}" />
			<arg value="-DarchivePrefix=${archivePrefix}" />
			<arg value="-Dgwt.location=${gwt.location}" />
			<arg value="-v" />
		</java>

	</target>
		
	<target name="sign-plugin-and-feature">
		<!-- Sign resulting plugin and feature -->
		<exec executable="${jarsigner.bin}">
			<arg path="${target.dir}/${archivePrefix}/**/*.jar" />
		</exec>
	</target>


</project>
